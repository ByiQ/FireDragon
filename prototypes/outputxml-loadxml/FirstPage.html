<!doctype html>
<html lang="en">
<head>
    <title>Health Systems Form Builder | Home</title>
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">
    <link rel="stylesheet" href="../styles/app.css">
    <script language="JavaScript" type="text/javascript" src="/src/app/jquery-3.2.1.min.js"></script>
    <script src="/old/app/app.js"></script>
    <script src="/old/app/formGeneration.js"></script>
    <script src="/prototypes/jerrid-demo/main.js"></script>
	<!-- .... -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/3.1.62/jquery.inputmask.bundle.js"></script>
    <script language="javascript" type="text/javascript">
		/** 
		 * @function WriteXmlFile allows users read data from .xml file back to form
		 * and allow adding more elements,then again saved to .xml updated file.
		 * 
		 * @author Huong Truong, 
		 * 
		 */
		var filename = "PatientForm.xml";
		var filenameText= "Patientcode.csv";
		var contentCsv = "";
		
		function WriteXmlFile(e) {
            try {
                var Frm = Settings.SrcElement(e);
                var XML = new XMLWriter();
                XML.BeginNode(Frm.name);
                XML.Attrib("Description", "Patient info.");
                var Nodes = Frm.elements;
                for (var i = 0; i < Nodes.length; i++) {
					//console.log(Nodes[i]);
					if(Nodes[i].type == "radio" || Nodes[i].type == "checkbox"){
						var isChecked = Nodes[i].checked ? "true" : "false";
						XML.BeginNode(Nodes[i].name);
						XML.Attrib("checked", isChecked);
						XML.WriteString(Nodes[i].value);
						XML.EndNode();
					} else {
						XML.Node(Nodes[i].name, Nodes[i].value);
					}
				}
                XML.EndNode();
                XML.Close();
				
				var text = XML.ToString().replace(/</g,"\n<");
				var pom = document.createElement('a');
				pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
				pom.setAttribute('download', filename);
				pom.style.display = 'none';
				document.body.appendChild(pom);

				pom.click();

				document.body.removeChild(pom);
				
            } catch(Err) {
                alert("Error: " + Err.description);
            }
            return false;
        }
		
		var downloadCsv = function(){
			//var content = $("#output").text();
			var pom = document.createElement('a');
			pom.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(contentCsv));
			pom.setAttribute('download', filenameText);
			pom.style.display = 'none';
			document.body.appendChild(pom);

			pom.click();

			document.body.removeChild(pom);
		};
		
		//function ReadXMLToFile(){
			//openFile will read XML file and input it into text field
			var openFile = function(event) {
				var input = event.target;
				var text = "";
				
				var reader = new FileReader();
				var onload = function(event) {
					text = reader.result;
					parseFile(text);

				};

				reader.onload = onload;
				reader.readAsText(input.files[0]);			
			};

		//this will parse XML file and output it to website
			var parseFile = function(text) {
				var xmlDoc = $.parseXML(text),
					$xml = $(xmlDoc);
					//$options = $xml.find("option");

				/*$.each($options, function() {
					$("#output").append("<li>" + $(this).text() + "</li >");
				});*/

				$nodes = $xml.find("*").eq(0)[0].children; //$xml.find(":root")[0].children;
				$.each($nodes, function() {
					var $tagName = $(this).prop("tagName");
					var $thisAttr = $(this).attr("checked");
					//$("#output").append("<li>" + $tagName +" - " + $(this).text() + "</li >");
					
					if ( typeof($(this).attr("checked")) == "undefined" ) {
						$("#output").append("<li>" + $tagName +" - " + $(this).text() + "</li >");
						contentCsv = contentCsv + $tagName + "," + $(this).text();
					} else {
						if ($thisAttr == "true") {
							$("#output").append("<li>" + $tagName +" - " + $(this).text() + "</li >");
							contentCsv = contentCsv + $tagName + "," + $(this).text();
						}
					}
					
				});
			};

	</script>
</head>
<body style="background-color: #bdd3e0; font-family: 'Noto Sans', sans-serif;" >
	<div class="containerheader" style="text-align: center;">
		<h1>Health Systems Form Builder</h1>
		<h2>Prototype v 1.0</h2>
	</div>
	<div class="row">
    
		<div class="column" style="margin: 80px;">
			<h2>Load new document</h2>
			<input type="button" value="New" onclick="newDoc()">
		</div>
		
		<div class="column" style="margin: 80px;">

			<form>
				<h3 id="choose file" class="chfile" align-text:right;> Select a xml file to view the patient info on plain text:</h3>
					<!-- <input type='file' accept='text/xml' onchange='openFile(event)'><br /><br> -->
					<!-- <!-- <input type="submit" value="View Patient Info"> -->
					<!-- <ul id="output"></ul> -->
					
					
					<input type='file' accept='text/xml' onchange='openFile(event)'><br />
					<input type="button" class="btn btn-primary mr-2" value="Download" style="margin-left:100px;" onclick="downloadCsv();">
					<ul id="output"></ul>
			</form>
		</div>
	</div>
<script>
    /* Prevent default submit form action from happening on "enter" action" */
    document.querySelector('#search_records').addEventListener("submit", function (e) {
        e.preventDefault();
    });
</script>
</body>
</html>